<!doctype html>
<html lang="ja" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex" />
    <title>2017/04/12: CloudFront Lamba@EdgeでBasic認証する</title>
    <link rel="alternate" type="application/rss+xml" title="rss" href="https://www.don.to/diary/index.rdf" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css" />
    <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
    <link href="/stylesheets/code.css" rel="stylesheet" />
    <link href="/stylesheets/photoswipe.css" rel="stylesheet" />
    <link href="/stylesheets/style.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@200..900&family=Reenie+Beanie&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/images/ipod-icon.png" />
    <meta name="viewport" content="width=device-width, user-scalable=yes, maximum-scale=2.0000" />
    <meta property="og:site_name" content="すみかわ日記">
    <meta property="og:title" content="2017/04/12: CloudFront Lamba@EdgeでBasic認証する">
  </head>

  <body>
    <div class="container">
      <div class="centerblock">
          <div class="titleblock">
            <h2><a href="/">すみかわ日記</a></h2>
          </div>
        <div class="mainblock">
          <div id="search"></div>
          <h2 data-pagefind-sort="date:2017-04-12">2017/04/12: CloudFront Lamba@EdgeでBasic認証する</h2>
          <main data-pagefind-body>
              <p><strong>2017/8: GA版にあわせて書き直しました</strong></p>

<p>CloudFront + S3オリジン構成の場合、Basic認証を使ったコンテンツ保護が出来ませんでしたが、<a href="http://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/lambda-at-the-edge.html">Lambda@Edge</a>によって可能になりました。</p>

<p>下記の機能を提供しています。</p>

<ul>
<li>一部のパスだけを認証の対象にできる。この例では、パスに<code>secret</code>が含まれるものだけが認証の対象です</li>
<li>Authorizationヘッダがなかった場合に401ではなく403を返すことで、ブラウザの認証ダイアログが表示される</li>
<li>認証エラー時にBodyを返却する</li>
<li>複数のクレデンシャルに対応している</li>
</ul>

<p>今のバージョンは、クレデンシャルがそのままハードコードされてるので、ソースの取り扱いにご注意を。
パスワードはハッシュをかけた方が安全ですが、これはTODOとします。</p>
<div class="highlight"><pre class="highlight javascript"><code><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">Records</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">cf</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">errorContent</span> <span class="o">=</span> <span class="dl">'</span><span class="se">\</span><span class="s1">
&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"&gt;</span><span class="se">\</span><span class="s1">
&lt;html&gt;&lt;head&gt;</span><span class="se">\</span><span class="s1">
&lt;title&gt;401 Authorization Required&lt;/title&gt;</span><span class="se">\</span><span class="s1">
&lt;/head&gt;&lt;body&gt;</span><span class="se">\</span><span class="s1">
&lt;h1&gt;Authorization Required&lt;/h1&gt;</span><span class="se">\</span><span class="s1">
&lt;p&gt;This server could not verify that you are authorized to access the document</span><span class="se">\</span><span class="s1">
requested.  Either you supplied the wrong credentials (e.g., bad password), or your</span><span class="se">\</span><span class="s1">
browser doesn</span><span class="se">\'</span><span class="s1">t understand how to supply the credentials required.&lt;/p&gt;</span><span class="se">\</span><span class="s1">
&lt;/body&gt;&lt;/html&gt;</span><span class="se">\</span><span class="s1">
</span><span class="dl">'</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">credentials</span> <span class="o">=</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">user1</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">pass1234</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">user2</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">pass5678</span><span class="dl">'</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/secret/i</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">authorities</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">Authorization</span> <span class="o">||</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">authorities</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">authorized</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">user</span> <span class="k">in</span> <span class="nx">credentials</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">secret</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">user</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">:</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">credentials</span><span class="p">[</span><span class="nx">user</span><span class="p">]).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">authorities</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">authorities</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="nx">secret</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">authorized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">authorized</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">match: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">authorities</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">not match: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">authorities</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">403</span><span class="dl">'</span><span class="p">,</span> <span class="na">statusDescription</span><span class="p">:</span> <span class="dl">'</span><span class="s1">403 Forbidden</span><span class="dl">'</span><span class="p">,</span>
                        <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
                          <span class="dl">'</span><span class="s1">content-type</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/html; charset=UTF-8</span><span class="dl">'</span> <span class="p">}</span> <span class="p">]</span>
                        <span class="p">},</span>
                        <span class="na">body</span><span class="p">:</span> <span class="nx">errorContent</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">)</span>
                       <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Client did not send authorization</span>
      <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="na">status</span><span class="p">:</span> <span class="dl">'</span><span class="s1">401</span><span class="dl">'</span><span class="p">,</span> <span class="na">statusDescription</span><span class="p">:</span> <span class="dl">'</span><span class="s1">401 Unauthorized</span><span class="dl">'</span><span class="p">,</span>
                      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
                        <span class="dl">'</span><span class="s1">www-authenticate</span><span class="dl">'</span><span class="p">:</span> <span class="p">[{</span> <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">WWW-Authenticate</span><span class="dl">'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Basic</span><span class="dl">'</span> <span class="p">}]</span>
                      <span class="p">}</span>
                     <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">do nothing</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

          </main>

          <nav class="prev_next" style="text-align: center; margin: 1em 0;"><a href="/diary/2017/0408-hanami/">&laquo; prev</a><span style="margin: 0 1em;">|</span><a href="/diary/2017/0414-hodogaya/">next &raquo;</a></nav>

          <hr />
          <div id="name">SUMIKAWA Munechika / Daydreamers On the Net</div>
        </div>
      </div>
      <div class="leftblock">
        <div class="eachindexblock nav">
  <ul id="gray">
      <li> <a href="/diary/2025.html">2025年</a></li>
      <li> <a href="/diary/2024.html">2024年</a></li>
      <li> <a href="/diary/2023.html">2023年</a></li>
      <li> <a href="/diary/2022.html">2022年</a></li>
      <li> <a href="/diary/2021.html">2021年</a></li>
      <li> <a href="/diary/2020.html">2020年</a></li>
      <li> <a href="/diary/2019.html">2019年</a></li>
      <li> <a href="/diary/2018.html">2018年</a></li>
      <li> <a href="/diary/2017.html">2017年</a></li>
      <li> <a href="/diary/2016.html">2016年</a></li>
      <li> <a href="/diary/2015.html">2015年</a></li>
      <li> <a href="/diary/2014.html">2014年</a></li>
      <li> <a href="/diary/2013.html">2013年</a></li>
      <li> <a href="/diary/2012.html">2012年</a></li>
      <li> <a href="/diary/2011.html">2011年</a></li>
      <li> <a href="/diary/2010.html">2010年</a></li>
      <li> <a href="/diary/2009.html">2009年</a></li>
      <li> <a href="/diary/2008.html">2008年</a></li>
      <li> <a href="/diary/2007.html">2007年</a></li>
      <li> <a href="/diary/2006.html">2006年</a></li>
      <li> <a href="/diary/2005.html">2005年</a></li>
      <li> <a href="/diary/2004.html">2004年</a></li>
      <li> <a href="/diary/2003.html">2003年</a></li>
      <li> <a href="/diary/2002.html">2002年</a></li>
      <li> <a href="/diary/2001.html">2001年</a></li>
      <li> <a href="/diary/2000.html">2000年</a></li>
      <li> <a href="/diary/1999.html">1999年</a></li>
      <li> <a href="/diary/1998.html">1998年</a></li>
      <li> <a href="/diary/1997.html">1997年</a></li>
      <li> <a href="/diary/1996.html">1996年</a></li>
    <li> <a href="/diary/1995.html">1995年以前</a></li>
  </ul>
</div>

      </div>
      <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

    </div>
    <script src="/pagefind/pagefind-ui.js"></script>
    <script src="/javascripts/diary.js"></script>
    <script src="/javascripts/photoswipe.umd.min.js"></script>
    <script src="/javascripts/photoswipe-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.5.0/dist/mermaid.min.js"></script>
  </body>
</html>
