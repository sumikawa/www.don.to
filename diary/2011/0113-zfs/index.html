<!doctype html>
<html lang="ja" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex">
    <title>2011/01/13: zfsでバックアップ管理</title>
    <link rel="alternate" type="application/rss+xml" title="rss" href="https://www.don.to/diary/index.rdf">
      <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
    <link href="/stylesheets/code.css" rel="stylesheet" />
    <link href="/stylesheets/photoswipe.css" rel="stylesheet" />
    <link href="/stylesheets/style.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@200..900&family=Reenie+Beanie&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/images/ipod-icon.png">
    <meta name="viewport" content="width=device-width, user-scalable=yes, maximum-scale=2.0000">
    <meta property="og:site_name" content="すみかわ日記">
    <meta property="og:title" content="2011/01/13: zfsでバックアップ管理">
  </head>

  <body data-source-path="/diary/2011/0113-zfs.html.md.erb">
    <div class="container">
      <div class="centerblock">
          <div class="titleblock">
            <h2><a href="/">すみかわ日記</a></h2>
          </div>
        <div class="mainblock">
          <div id="search"></div>
          <h2 data-pagefind-sort="date:2011-01-13">2011/01/13: zfsでバックアップ管理</h2>
          <main data-pagefind-body>
              <p>おうちサーバをzfs(+mirror)構成にしたので、バックアップをzfs snapshotでとるようにしました。
ディスク構成はこんな感じ。</p>

<pre class="terminal">
% zpool status
  pool: tank
 state: ONLINE
 scrub: scrub completed after 5h58m with 0 errors on Tue Jan 11 19:08:30 2011
config:

    NAME                                            STATE     READ WRITE CKSUM
    tank                                            ONLINE       0     0     0
      mirror                                        ONLINE       0     0     0
        gptid/b4ede3f7-7374-11df-88ce-02301b00361b  ONLINE       0     0     0
        gptid/195e4153-c00c-11df-bd35-02301b00361b  ONLINE       0     0     0

errors: No known data errors
% df -g
Filesystem       1G-blocks Used Avail Capacity  Mounted on
/dev/ad4p2               1    0     1    24%    /
devfs                    0    0     0   100%    /dev
/dev/md0                 0    0     0     0%    /tmp
procfs                   0    0     0   100%    /proc
tank                   842    0   842     0%    /tank
tank/local            1623  781   842    48%    /usr/local
tank/obj               844    2   842     0%    /usr/obj
tank/ports             844    1   842     0%    /usr/ports
tank/src               843    0   842     0%    /usr/src
devfs                    0    0     0   100%    /var/named/dev
</pre>

<p>/usr/local以下(tank/local)を毎日バックアップします。
まず、cronで毎晩下記のシェルスクリプトをroot権限で実行します。</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c">#!/bin/sh</span>
zfs snapshot tank/local@<span class="sb">`</span><span class="nb">date</span> <span class="s2">"+%Y%m%d"</span><span class="sb">`</span>
</code></pre></div>

<p>以前に使ってた<a href="http://0xcc.net/pdumpfs/">pdumpfs</a>の場合は一時間ぐらいかかってバックアップを作成してましたが、snapshotは一瞬で出来上がります。
snapshotはzfs listで確認できます。</p>

<pre class="terminal">
% zfs list -t snapshot
NAME                   USED  AVAIL  REFER  MOUNTPOINT
tank/local@20101229   29.2M      -   693G  -
tank/local@20101230   22.2M      -   700G  -
tank/local@20101231   21.6M      -   711G  -
tank/local@20110101   22.7M      -   711G  -
tank/local@20110102   20.3M      -   711G  -
tank/local@20110103   21.0M      -   712G  -
tank/local@20110104   11.2G      -   733G  -
tank/local@20110105   6.26G      -   753G  -
tank/local@20110106    208M      -   747G  -
tank/local@20110107    195M      -   747G  -
tank/local@20110108   7.75G      -   762G  -
tank/local@20110109    291M      -   771G  -
tank/local@20110110    193M      -   769G  -
tank/local@20110111    219M      -   782G  -
tank/local@20110112    275M      -   781G  -
tank/local@20110113   72.0M      -   781G  -
</pre>

<p>このままにしておくと、snapshotが日毎に際限なく増えていくので、過去のsnapshotは間引いていきます。
pdumpfs-cleanをベースに<a href="https://gist.github.com/777602">snapshot-clean</a>というrubyスクリプトを作りました。</p>

<p>僕の場合、下記のルールでバックアップを保持しています。</p>

<ul>
<li>Daily backupを7日分</li>
<li>Weekly backupを8週間分</li>
<li>Monthly backupを18ケ月分</li>
<li>Yearly backupを4年分</li>
</ul>

<p>下記の引数で<code>snapshot-clean</code>を実行すると、過去のsnapshotがこのルールを元に消されていきます。
削除もあっという間に終わります。</p>

<pre class="terminal">
% sudo snapshot-clean -v --keep 4Y18M8W7D
Deleting tank/local@20101229 ... done.
Deleting tank/local@20101230 ... done.
Deleting tank/local@20101231 ... done.
Deleting tank/local@20110103 ... done.
Deleting tank/local@20110104 ... done.
Deleting tank/local@20110105 ... done.
Deleting tank/local@20110106 ... done.
Keep snapshots:
tank/local@20110101
tank/local@20110102
tank/local@20110107
tank/local@20110108
tank/local@20110109
tank/local@20110110
tank/local@20110111
tank/local@20110112
tank/local@20110113
tank/obj@null
</pre>

<p>バックアップは、(mountpoint)/.zfs/snapshot/からアクセスできます。</p>

<pre class="terminal">
% ls -l /usr/local/.zfs/snapshot/
drwxr-xr-x  20 root  wheel  20 Jul 21 22:00 20110101/
drwxr-xr-x  20 root  wheel  20 Jul 21 22:00 20110102/
drwxr-xr-x  20 root  wheel  20 Jul 21 22:00 20110107/
drwxr-xr-x  20 root  wheel  20 Jul 21 22:00 20110108/
drwxr-xr-x  20 root  wheel  20 Jul 21 22:00 20110109/
drwxr-xr-x  20 root  wheel  20 Jul 21 22:00 20110110/
drwxr-xr-x  20 root  wheel  20 Jul 21 22:00 20110111/
drwxr-xr-x  20 root  wheel  20 Jul 21 22:00 20110112/
drwxr-xr-x  20 root  wheel  20 Jul 21 22:00 20110113/
</pre>

<p>当たり前ですが、スナップショットは同一HDD内に保持するため、HDD 1台でzfsしている環境だとHDD壊れたらバックアップごと吹っ飛びます。
ミラー構成やRAID構成が前提です。</p>



              <div class="tags">
                Tags:
                  <a href="/tag/server/">server</a> (4)
                  <a href="/tag/tech/">tech</a> (40)
              </div>
          </main>

          <nav class="prev_next" style="text-align: center; margin: 1em 0;"><a href="/diary/2011/0113-riri/">&laquo; prev</a><span style="margin: 0 1em;">|</span><a href="/diary/2011/0115-hoikuen/">next &raquo;</a></nav>

          <hr>
          <div id="name">SUMIKAWA Munechika / Daydreamers On the Net</div>
        </div>
      </div>
      <div class="leftblock">
        <div class="eachindexblock nav">
  <ul id="gray">
      <li> <a href="/diary/2026.html">2026年</a></li>
      <li> <a href="/diary/2025.html">2025年</a></li>
      <li> <a href="/diary/2024.html">2024年</a></li>
      <li> <a href="/diary/2023.html">2023年</a></li>
      <li> <a href="/diary/2022.html">2022年</a></li>
      <li> <a href="/diary/2021.html">2021年</a></li>
      <li> <a href="/diary/2020.html">2020年</a></li>
      <li> <a href="/diary/2019.html">2019年</a></li>
      <li> <a href="/diary/2018.html">2018年</a></li>
      <li> <a href="/diary/2017.html">2017年</a></li>
      <li> <a href="/diary/2016.html">2016年</a></li>
      <li> <a href="/diary/2015.html">2015年</a></li>
      <li> <a href="/diary/2014.html">2014年</a></li>
      <li> <a href="/diary/2013.html">2013年</a></li>
      <li> <a href="/diary/2012.html">2012年</a></li>
      <li> <a href="/diary/2011.html">2011年</a></li>
      <li> <a href="/diary/2010.html">2010年</a></li>
      <li> <a href="/diary/2009.html">2009年</a></li>
      <li> <a href="/diary/2008.html">2008年</a></li>
      <li> <a href="/diary/2007.html">2007年</a></li>
      <li> <a href="/diary/2006.html">2006年</a></li>
      <li> <a href="/diary/2005.html">2005年</a></li>
      <li> <a href="/diary/2004.html">2004年</a></li>
      <li> <a href="/diary/2003.html">2003年</a></li>
      <li> <a href="/diary/2002.html">2002年</a></li>
      <li> <a href="/diary/2001.html">2001年</a></li>
      <li> <a href="/diary/2000.html">2000年</a></li>
      <li> <a href="/diary/1999.html">1999年</a></li>
      <li> <a href="/diary/1998.html">1998年</a></li>
      <li> <a href="/diary/1997.html">1997年</a></li>
      <li> <a href="/diary/1996.html">1996年</a></li>
    <li> <a href="/diary/1995.html">1995年以前</a></li>
    <li> <a href="/tag/tag_list/">Tags</a></li>
  </ul>
</div>

      </div>
      <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

    </div>
    <script src="/javascripts/diary.js"></script>
      <script src="/pagefind/pagefind-ui.js"></script>
      <script src="/javascripts/search.js"></script>
    <script src="/javascripts/photoswipe.umd.min.js"></script>
    <script src="/javascripts/photoswipe-init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.5.0/dist/mermaid.min.js"></script>

  </body>
</html>
